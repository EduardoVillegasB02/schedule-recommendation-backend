generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Rol {
  ADMIN
  ALUMNO
  PROFESOR
}

model alumno {
  id                 Int                  @id @default(autoincrement())
  nombres            String?
  apellidos          String?
  codigo             String               @unique @db.VarChar(20)
  promedio           Decimal?             @db.Decimal(4, 2)
  ciclo_relativo     Int
  creditos_aprobados Int?                 @default(0)
  estado             String?              @default("N") @db.VarChar(20)
  token              String?
  created_at         DateTime             @default(now())
  deleted_at         DateTime?
  log_ciclo_relativo log_ciclo_relativo[]
  log_creditos       log_creditos[]
  matricula          matricula[]
  usuario            usuario?
}

model curso {
  id                                                       Int                   @id @default(autoincrement())
  codigo                                                   String                @unique @db.VarChar(10)
  nombre                                                   String                @db.VarChar(200)
  tipo                                                     String                @db.Char(1)
  ciclo                                                    String                @db.VarChar(20)
  sistema_eval                                             String                @db.Char(1)
  ht                                                       Int
  hp                                                       Int
  hl                                                       Int
  creditos                                                 Int
  curso_ofertado                                           curso_ofertado[]
  curso_prerrequisito_curso_prerrequisito_curso_idTocurso  curso_prerrequisito[] @relation("curso_prerrequisito_curso_idTocurso")
  curso_prerrequisito_curso_prerrequisito_prereq_idTocurso curso_prerrequisito[] @relation("curso_prerrequisito_prereq_idTocurso")
  historial_demanda                                        historial_demanda[]
  log_creditos                                             log_creditos[]
}

model curso_ofertado {
  id                   Int         @id @default(autoincrement())
  curso_id             Int
  profesor_id          Int?
  semestre             String      @db.VarChar(10)
  codigo_seccion       String      @default("M") @db.Char(1)
  turno                String      @db.VarChar(20)
  cupos_disponibles    Int
  alumnos_matriculados Int?        @default(0)
  curso                curso       @relation(fields: [curso_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profesor             profesor?   @relation(fields: [profesor_id], references: [id], onUpdate: NoAction)
  matricula            matricula[]

  @@unique([curso_id, semestre, codigo_seccion])
}

model curso_prerrequisito {
  id                                         Int   @id @default(autoincrement())
  curso_id                                   Int
  prereq_id                                  Int
  curso_curso_prerrequisito_curso_idTocurso  curso @relation("curso_prerrequisito_curso_idTocurso", fields: [curso_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  curso_curso_prerrequisito_prereq_idTocurso curso @relation("curso_prerrequisito_prereq_idTocurso", fields: [prereq_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model historial_demanda {
  id                        Int      @id @default(autoincrement())
  curso_id                  Int
  semestre                  String   @db.VarChar(10)
  alumnos_matriculados      Int
  tasa_aprobacion           Decimal? @db.Decimal(4, 2)
  num_secciones             Int?     @default(1)
  promedio_creditos_alumnos Decimal? @db.Decimal(5, 2)
  demanda_normalizada       Decimal? @db.Decimal(4, 3)
  curso                     curso    @relation(fields: [curso_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([curso_id, semestre])
}

model log_ciclo_relativo {
  id                 Int       @id @default(autoincrement())
  alumno_id          Int
  ciclo_anterior     Int?
  ciclo_nuevo        Int?
  creditos_aprobados Int
  fecha              DateTime? @default(now()) @db.Timestamp(6)
  alumno             alumno    @relation(fields: [alumno_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model log_creditos {
  id        Int       @id @default(autoincrement())
  alumno_id Int
  curso_id  Int
  creditos  Int
  accion    String    @db.VarChar(50)
  fecha     DateTime? @default(now()) @db.Timestamp(6)
  alumno    alumno    @relation(fields: [alumno_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  curso     curso     @relation(fields: [curso_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model matricula {
  id                Int            @id @default(autoincrement())
  alumno_id         Int
  curso_ofertado_id Int
  fecha_matricula   DateTime       @default(dbgenerated("CURRENT_DATE")) @db.Date
  nota_final        Decimal?       @db.Decimal(4, 2)
  estado            String?        @default("Matriculado") @db.VarChar(20)
  alumno            alumno         @relation(fields: [alumno_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  curso_ofertado    curso_ofertado @relation(fields: [curso_ofertado_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([alumno_id, curso_ofertado_id])
}

model profesor {
  id                Int              @id @default(autoincrement())
  nombre            String           @db.VarChar(150)
  experiencia_anios Int?             @default(0)
  popularidad       Decimal?         @default(0.00) @db.Decimal(3, 2)
  codigo_profesor   String?          @unique(map: "unique_codigo_profesor") @db.VarChar(10)
  token             String?
  curso_ofertado    curso_ofertado[]
  usuario           usuario?
}

model usuario {
  id         Int       @id @default(autoincrement())
  email      String    @unique @db.VarChar(255)
  password   String    @db.VarChar(255)
  rol        Rol       @default(ALUMNO)
  alumno_id  Int?      @unique
  profesor_id Int?     @unique
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  alumno     alumno?   @relation(fields: [alumno_id], references: [id], onDelete: Cascade)
  profesor   profesor? @relation(fields: [profesor_id], references: [id], onDelete: Cascade)
}